<!DOCTYPE html>
<html lang="en">
  <head>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0Q1VZ5TT2T"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-0Q1VZ5TT2T');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filter</title>
    <link rel="stylesheet" href="styles6.css">
  </head>
  <body>
    <header>
      <nav>
        <a href="index.html" class="home-button">Home</a>
      </nav>
    </header>

    <main>
      <div class="filter-container">
        <button id="filter-type-btn">Movie</button>
        <div id="type-dropdown" class="dropdown-content">
          <a href="#" data-type="movie">Movie</a>
          <a href="#" data-type="tv">TV Show</a>
        </div>
        
        <button id="genre-dropdown-btn" class="active">Genres</button>
        <div id="genre-dropdown" class="dropdown-content">
          <!-- Genre options will be added here dynamically -->
        </div>

        <button id="more-filters-btn">More Filters</button>
        <div id="more-filters-dropdown" class="dropdown-content">
          <a href="#" id="top-rated-option">Most Rated</a>
          <a href="#" id="trending-option">Trending</a>
        </div>
      </div>

      <div id="results">
        <p id="results-count">Showing __ Results</p>
        <div class="results-grid" id="results-grid"></div>
      </div>
    </main>

    <footer>
      <p>&copy; 2024 FireFlix. All rights reserved.</p>
    </footer>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const apiKey = '7967738a03ec215c7d6d675faba9c973';
        const genreDropdown = document.getElementById('genre-dropdown');
        const resultsGrid = document.getElementById('results-grid');
        const resultsCount = document.getElementById('results-count');
        const typeDropdown = document.getElementById('type-dropdown');
        const moreFiltersDropdown = document.getElementById('more-filters-dropdown');
        const filterTypeBtn = document.getElementById('filter-type-btn');
        const topRatedOption = document.getElementById('top-rated-option');
        const trendingOption = document.getElementById('trending-option');
        const genreDropdownBtn = document.getElementById('genre-dropdown-btn');
        let mediaType = 'movie';
        let selectedGenres = new Set();
        let isTopRated = false;
        let isTrending = false;

        async function fetchGenres() {
          const response = await fetch(`https://api.themoviedb.org/3/genre/${mediaType}/list?api_key=${apiKey}&language=en-US`);
          const data = await response.json();
          populateGenreDropdown(data.genres);
        }

        function populateGenreDropdown(genres) {
          genreDropdown.innerHTML = '';
          genres.forEach(genre => {
            const genreItem = document.createElement('a');
            genreItem.textContent = genre.name;
            genreItem.setAttribute('data-id', genre.id);
            genreItem.classList.toggle('selected', selectedGenres.has(genre.id));
            genreItem.addEventListener('click', (e) => toggleGenreSelection(genre.id, genreItem, e));
            genreDropdown.appendChild(genreItem);
          });
        }

        function toggleGenreSelection(genreId, genreItem, e) {
          e.stopPropagation();
          if (selectedGenres.has(genreId)) {
            selectedGenres.delete(genreId);
            genreItem.classList.remove('selected');
          } else {
            selectedGenres.add(genreId);
            genreItem.classList.add('selected');
          }
          filterResults();
        }

        async function fetchIMDbID(tmdbId) {
          const response = await fetch(`https://api.themoviedb.org/3/${mediaType}/${tmdbId}/external_ids?api_key=${apiKey}`);
          const data = await response.json();
          return data.imdb_id;
        }

        async function displayResults(movies) {
          resultsGrid.innerHTML = '';
          if (movies.length === 0) {
            resultsGrid.innerHTML = '<p class="no-results">No Results Found</p>';
            return;
          }

          for (const movie of movies) {
            const movieDiv = document.createElement('div');
            const movieImg = document.createElement('img');
            movieImg.src = movie.poster_path ? `https://image.tmdb.org/t/p/w500${movie.poster_path}` : 'default.jpg'; // Handle broken images
            movieImg.alt = movie.title || movie.name;
            movieDiv.appendChild(movieImg);
            movieDiv.addEventListener('click', async () => {
              const imdbID = await fetchIMDbID(movie.id);
              window.location.href = `movie.html?imdb_id=${imdbID}&type=${mediaType}`;
            });
            resultsGrid.appendChild(movieDiv);
          }

          resultsCount.textContent = `Showing ${movies.length} Results`;
        }

        async function filterResults() {
          const genres = Array.from(selectedGenres).join(',');
          let url = `https://api.themoviedb.org/3/discover/${mediaType}?api_key=${apiKey}&with_genres=${genres}&sort_by=popularity.desc`;

          const response = await fetch(url);
          const data = await response.json();
          displayResults(data.results);
        }

        async function filterTopRated() {
          const url = `https://api.themoviedb.org/3/${mediaType}/top_rated?api_key=${apiKey}`;
          const response = await fetch(url);
          const data = await response.json();
          displayResults(data.results);
        }

        async function filterTrending() {
          const url = `https://api.themoviedb.org/3/trending/${mediaType}/week?api_key=${apiKey}`;
          const response = await fetch(url);
          const data = await response.json();
          displayResults(data.results);
        }

        function closeAllDropdowns() {
          genreDropdown.classList.remove('show');
          typeDropdown.classList.remove('show');
          moreFiltersDropdown.classList.remove('show');
        }

        function disableGenreButton(disable) {
          if (disable) {
            genreDropdownBtn.classList.add('disabled');
            genreDropdownBtn.setAttribute('disabled', 'true');
          } else {
            genreDropdownBtn.classList.remove('disabled');
            genreDropdownBtn.removeAttribute('disabled');
          }
        }

        document.getElementById('genre-dropdown-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          closeAllDropdowns();
          genreDropdown.classList.toggle('show');
        });

        filterTypeBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          closeAllDropdowns();
          typeDropdown.classList.toggle('show');
        });

        document.getElementById('more-filters-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          closeAllDropdowns();
          moreFiltersDropdown.classList.toggle('show');
        });

        topRatedOption.addEventListener('click', (e) => {
          e.stopPropagation();
          isTopRated = !isTopRated;
          isTrending = false;
          topRatedOption.classList.toggle('selected', isTopRated);
          trendingOption.classList.remove('selected');
          disableGenreButton(isTopRated || isTrending);
          if (isTopRated) {
            filterTopRated();
          } else {
            filterResults();
          }
        });

        trendingOption.addEventListener('click', (e) => {
          e.stopPropagation();
          isTrending = !isTrending;
          isTopRated = false;
          trendingOption.classList.toggle('selected', isTrending);
          topRatedOption.classList.remove('selected');
          disableGenreButton(isTopRated || isTrending);
          if (isTrending) {
            filterTrending();
          } else {
            filterResults();
          }
        });

        typeDropdown.addEventListener('click', (e) => {
          e.stopPropagation();
          const selectedType = e.target.getAttribute('data-type');
          if (selectedType) {
            mediaType = selectedType;
            filterTypeBtn.textContent = selectedType.charAt(0).toUpperCase() + selectedType.slice(1);
            typeDropdown.classList.remove('show');
            selectedGenres.clear(); // Clear selected genres when switching types
            fetchGenres();
            filterResults();
          }
        });

        document.addEventListener('click', () => {
          closeAllDropdowns();
        });

        fetchGenres();
        filterResults();
      });
    </script>
  </body>
</html>