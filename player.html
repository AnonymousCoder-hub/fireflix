<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0Q1VZ5TT2T"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-0Q1VZ5TT2T');
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Watch movies and TV shows on FireFlix." />
    <meta property="og:title" content="FireFlix - Watch Movies and TV Shows" />
    <meta property="og:description" content="Stream your favorite movies and TV shows." />
    <title>Watch Now - FireFlix</title>
    <link rel="icon" type="image/x-icon" href="logo.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="styles4.css" />
  </head>
  <body>

    <!-- Modern Header -->
    <header class="modern-header player-header">
      <nav class="navbar">
        <div class="nav-left">
          <a href="index.html" class="logo">
            <svg class="logo-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            <span>FireFlix</span>
          </a>
        </div>
        <div class="nav-right">
          <a href="index.html" class="back-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="19" y1="12" x2="5" y2="12"></line>
              <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            Home
          </a>
        </div>
      </nav>
    </header>

    <main class="player-main">
      <!-- Movie Logo -->
      <div class="logo-container">
        <img id="movie-logo" src="" alt="Movie Logo" class="hidden" />
      </div>

      <!-- Player Section -->
      <div class="player-section">
        <div class="player-wrapper">
          <div class="player-container">
            <iframe
              id="player-frame"
              src=""
              frameborder="0"
              allowfullscreen
              mozallowfullscreen
              webkitallowfullscreen
              scrolling="no"
              title="Movie Player"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            ></iframe>
          </div>

          <!-- Source Selector -->
          <div class="source-selector">
            <button class="source-btn" id="selected-source">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
              </svg>
              <span>EZsource</span>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="chevron">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <div class="source-dropdown" id="source-dropdown">
              <button class="source-option active" data-source="EZsource">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <circle cx="12" cy="12" r="10"/>
                </svg>
                EZsource
              </button>
              <button class="source-option" data-source="Vidsrc1">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <rect x="2" y="2" width="20" height="20" rx="2"/>
                </svg>
                Vidsrc1
              </button>
              <button class="source-option" data-source="AutoEmbed">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <polygon points="12 2 22 8.5 22 15.5 12 22 2 15.5 2 8.5 12 2"/>
                </svg>
                AutoEmbed
              </button>
            </div>
          </div>
        </div>

        <!-- Movie Description -->
        <p id="movie-description" class="movie-desc"></p>

        <!-- Episodes and Seasons Section -->
        <section class="episodes-section" id="episodes">
          <div class="section-header">
            <h2 class="section-title">
              <span class="title-icon">üì∫</span>
              Episodes
            </h2>
          </div>

          <!-- Season Tabs -->
          <div class="season-tabs" id="season-tabs">
            <!-- Seasons will be inserted here -->
          </div>

          <!-- Episode List -->
          <div class="episode-list" id="episode-list">
            <!-- Episodes will be inserted here -->
          </div>
        </section>
      </div>

      <!-- Similar Movies/TV Shows Section -->
      <section class="content-section" id="similar">
        <div class="section-header">
          <h2 class="section-title">
            <span class="title-icon">üëç</span>
            Similar Movies/TV Shows
          </h2>
          <div class="section-actions">
            <button class="action-btn scroll-left" data-target="similar-grid">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
            </button>
            <button class="action-btn scroll-right" data-target="similar-grid">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </button>
          </div>
        </div>
        <div class="content-scroller">
          <div class="grid modern-grid" id="similar-grid">
            <!-- Similar items will be inserted here -->
          </div>
        </div>
      </section>

      <!-- On The Air Section -->
      <section class="content-section" id="on-the-air">
        <div class="section-header">
          <h2 class="section-title">
            <span class="title-icon">üì∫</span>
            On The Air
          </h2>
          <div class="section-actions">
            <button class="action-btn scroll-left" data-target="on-the-air-grid">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
            </button>
            <button class="action-btn scroll-right" data-target="on-the-air-grid">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </button>
          </div>
        </div>
        <div class="content-scroller">
          <div class="grid modern-grid" id="on-the-air-grid">
            <!-- On the air items will be inserted here -->
          </div>
        </div>
      </section>

      <!-- Recommendations Section -->
      <section class="content-section" id="recommendations">
        <div class="section-header">
          <h2 class="section-title">
            <span class="title-icon">‚≠ê</span>
            Recommendations
          </h2>
          <div class="section-actions">
            <button class="action-btn scroll-left" data-target="recommendations-grid">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
            </button>
            <button class="action-btn scroll-right" data-target="recommendations-grid">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </button>
          </div>
        </div>
        <div class="content-scroller">
          <div class="grid modern-grid" id="recommendations-grid">
            <!-- Recommendations will be inserted here -->
          </div>
        </div>
      </section>
    </main>

    <footer class="modern-footer">
      <div class="footer-content">
        <div class="footer-section">
          <h4>FireFlix</h4>
          <p>Stream your favorite movies and TV shows in HD quality.</p>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2024 FireFlix. All rights reserved.</p>
      </div>
    </footer>

    <script>
      const apiKey = "7967738a03ec215c7d6d675faba9c973";
      const urlParams = new URLSearchParams(window.location.search);
      const imdbId = urlParams.get("imdb_id");
      let mediaType;
      let tmdbId;
      const playerFrame = document.getElementById("player-frame");
      const sourceDropdown = document.getElementById("source-dropdown");
      const selectedSource = document.getElementById("selected-source");
      const movieLogo = document.getElementById("movie-logo");
      const movieDescription = document.getElementById("movie-description");
      let currentSource = "EZsource";
      let currentSeason = 1;
      let currentEpisode = 1;

      // Remembering the last used source
      const rememberSourceSetting = localStorage.getItem("rememberSource");
      if (rememberSourceSetting === "true") {
        const rememberedSource = localStorage.getItem("lastUsedSource");
        if (rememberedSource) {
          currentSource = rememberedSource;
          updateSourceButton(currentSource);
        }
      }

      console.log("Initial imdbId:", imdbId);

      async function fetchMovieDetails(imdbId) {
        try {
          const response = await fetch(
            `https://api.themoviedb.org/3/find/${imdbId}?api_key=${apiKey}&external_source=imdb_id`
          );
          const data = await response.json();
          if (data.movie_results.length || data.tv_results.length) {
            const movie = data.movie_results[0] || data.tv_results[0];
            mediaType = movie.media_type;
            tmdbId = movie.id;
            displayMovieDetails(movie);
            await fetchAdditionalData(tmdbId, mediaType);
            if (mediaType === "tv") {
              const lastPlayed = getLastPlayed(tmdbId);
              currentSeason = lastPlayed.season;
              currentEpisode = lastPlayed.episode;
              await fetchSeasons(tmdbId);
              await fetchEpisodes(tmdbId, currentSeason);
            }
          } else {
            console.error("No movie or TV show found.");
          }
        } catch (error) {
          console.error("Error fetching movie details: ", error);
        }
      }

      function displayMovieDetails(movie) {
        const lastPlayed = getLastPlayed(tmdbId);
        updatePlayerFrame(tmdbId, lastPlayed.season, lastPlayed.episode);
        movieDescription.textContent = movie.overview;

        // Fetch the banner image
        const bannerUrl = `https://image.tmdb.org/t/p/original${movie.backdrop_path}`;
        document.documentElement.style.setProperty('--banner-url', `url(${bannerUrl})`);

        // Fetch the logo image
        fetchLogo(movie.id, mediaType);
      }

      async function fetchLogo(movieId, mediaType) {
        try {
          const response = await fetch(
            `https://api.themoviedb.org/3/${mediaType}/${movieId}/images?api_key=${apiKey}`
          );
          const data = await response.json();

          // Filter logos to only get English logos
          const englishLogos = data.logos.filter(logo => logo.iso_639_1 === 'en');

          const logo = englishLogos.length > 0 ? englishLogos[0].file_path : '';

          if (logo) {
            const logoUrl = `https://image.tmdb.org/t/p/original${logo}`;
            movieLogo.src = logoUrl;
            movieLogo.classList.remove("hidden");
          }
        } catch (error) {
          console.error("Error fetching logo: ", error);
        }
      }

      async function fetchAdditionalData(movieId, mediaType) {
        await fetchSimilar(movieId, mediaType);
        await fetchOnTheAir();
        await fetchRecommendations(movieId, mediaType);
      }

      async function fetchSimilar(movieId, mediaType) {
        try {
          const response = await fetch(
            `https://api.themoviedb.org/3/${mediaType}/${movieId}/similar?api_key=${apiKey}`
          );
          const data = await response.json();
          displayAdditionalContent(data.results, "similar-grid");
        } catch (error) {
          console.error("Error fetching similar content: ", error);
        }
      }

      async function fetchOnTheAir() {
        try {
          const response = await fetch(
            `https://api.themoviedb.org/3/tv/on_the_air?api_key=${apiKey}`
          );
          const data = await response.json();
          displayAdditionalContent(data.results, "on-the-air-grid");
        } catch (error) {
          console.error("Error fetching on-the-air content: ", error);
        }
      }

      async function fetchRecommendations(movieId, mediaType) {
        try {
          const response = await fetch(
            `https://api.themoviedb.org/3/${mediaType}/${movieId}/recommendations?api_key=${apiKey}`
          );
          const data = await response.json();
          displayAdditionalContent(data.results, "recommendations-grid");
        } catch (error) {
          console.error("Error fetching recommendations: ", error);
        }
      }

      function displayAdditionalContent(items, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        items.forEach((item) => {
          if (!item.poster_path && !item.backdrop_path) return;

          const div = document.createElement("div");
          const img = document.createElement("img");
          img.src = `https://image.tmdb.org/t/p/w500${item.poster_path || item.backdrop_path}`;
          img.alt = item.title || item.name;
          div.appendChild(img);

          div.addEventListener("click", async () => {
            const imdbId = await fetchIMDbID(
              item.id,
              item.media_type || (item.first_air_date ? "tv" : "movie")
            );
            window.location.href = `movie.html?imdb_id=${imdbId}`;
          });

          container.appendChild(div);
        });
      }

      async function fetchIMDbID(tmdbId, type) {
        try {
          const response = await fetch(
            `https://api.themoviedb.org/3/${type}/${tmdbId}/external_ids?api_key=${apiKey}`
          );
          const data = await response.json();
          return data.imdb_id;
        } catch (error) {
          console.error(
            `Error fetching IMDb ID for ${type} with TMDB ID ${tmdbId}: `,
            error
          );
        }
      }

      async function fetchSeasons(tvId) {
        try {
          const response = await fetch(
            `https://api.themoviedb.org/3/tv/${tvId}?api_key=${apiKey}`
          );
          const data = await response.json();
          displaySeasons(data.seasons, tvId);
        } catch (error) {
          console.error("Error fetching seasons: ", error);
        }
      }

      function displaySeasons(seasons, tvId) {
        const seasonTabs = document.getElementById("season-tabs");
        seasonTabs.innerHTML = "";
        seasons.forEach((season) => {
          const button = document.createElement("button");
          button.classList.add("season-tab");
          button.textContent = `Season ${season.season_number}`;
          button.dataset.season = season.season_number;

          if (season.season_number === currentSeason) {
            button.classList.add("active");
          }

          button.addEventListener("click", () => {
            currentSeason = season.season_number;
            document.querySelectorAll('.season-tab').forEach(tab => tab.classList.remove('active'));
            button.classList.add('active');
            fetchEpisodes(tvId, season.season_number);
          });

          seasonTabs.appendChild(button);
        });
      }

      async function fetchEpisodes(tvId, seasonNumber) {
        try {
          const response = await fetch(
            `https://api.themoviedb.org/3/tv/${tvId}/season/${seasonNumber}?api_key=${apiKey}`
          );
          const data = await response.json();
          displayEpisodes(data.episodes);
        } catch (error) {
          console.error("Error fetching episodes: ", error);
        }
      }

      function displayEpisodes(episodes) {
        const episodeList = document.getElementById("episode-list");
        episodeList.innerHTML = "";
        episodes.forEach((episode) => {
          const div = document.createElement("div");
          div.classList.add("episode-item");

          const img = document.createElement("img");
          img.src = `https://image.tmdb.org/t/p/w500${episode.still_path}`;
          img.alt = episode.name;
          img.classList.add("episode-thumb");

          const episodeInfo = document.createElement("div");
          episodeInfo.classList.add("episode-info");

          const episodeNumber = document.createElement("span");
          episodeNumber.classList.add("episode-number");
          episodeNumber.textContent = `EP ${episode.episode_number}`;

          const title = document.createElement("h3");
          title.textContent = episode.name;

          const overview = document.createElement("p");
          overview.textContent = episode.overview || "No description available.";

          const playIcon = document.createElement("div");
          playIcon.classList.add("play-icon");
          playIcon.innerHTML = `
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M8 5v14l11-7z"/>
            </svg>
          `;

          episodeInfo.appendChild(episodeNumber);
          episodeInfo.appendChild(title);
          episodeInfo.appendChild(overview);

          div.appendChild(img);
          div.appendChild(episodeInfo);
          div.appendChild(playIcon);

          // Check if this episode is the last played episode
          if (episode.episode_number === currentEpisode) {
            div.classList.add('active');
          }

          div.addEventListener("click", () => {
            document.querySelectorAll('.episode-item').forEach(item => item.classList.remove('active'));
            div.classList.add('active');
            currentEpisode = episode.episode_number;
            storeLastPlayed(tmdbId, currentSeason, currentEpisode);
            updatePlayerFrame(tmdbId, currentSeason, currentEpisode);
          });

          episodeList.appendChild(div);
        });
      }

      function updatePlayerFrame(tmdbId, season, episode) {
        let srcUrl = "";
        let isSandbox = false;

        if (mediaType === "movie") {
            switch (currentSource) {
                case "EZsource":
                    srcUrl = `https://lethe399key.com/play/${imdbId}`;
                    break;
                case "AutoEmbed":
                    srcUrl = `https://player.autoembed.cc/embed/movie/${imdbId}?server=15`;
                    break;
                case "Vidsrc1":
                    srcUrl = `https://vidsrc.cc/v2/embed/movie/${imdbId}`;
                    break;
                default:
                    srcUrl = `https://lethe399key.com/play/${imdbId}`;
                    isSandbox = true;
                    break;
            }
        } else if (mediaType === "tv") {
            switch (currentSource) {
                case "EZsource":
                    srcUrl = `https://lethe399key.com/play/${imdbId}`;
                    break;
                case "AutoEmbed":
                    srcUrl = `https://player.autoembed.cc/embed/tv/${imdbId}/${season}/${episode}?server=15`;
                    break;
                case "Vidsrc1":
                    srcUrl = `https://vidsrc.cc/v2/embed/tv/${imdbId}/${season}/${episode}`;
                    isSandbox = true;
                    break;
                default:
                    srcUrl = `https://lethe399key.com/play/${imdbId}`;
                    isSandbox = true;
                    break;
            }
        }

        console.log("Generated URL:", srcUrl);
        playerFrame.src = srcUrl;

        // Apply sandbox attribute if isSandbox is true
        if (isSandbox) {
            playerFrame.setAttribute("sandbox", "allow-scripts allow-same-origin allow-presentation");
        } else {
            playerFrame.removeAttribute("sandbox");
        }

        // Save current source if the setting is enabled
        if (rememberSourceSetting === "true") {
            localStorage.setItem("lastUsedSource", currentSource);
        }
      }

      // Function to store last played episode and season in localStorage
      function storeLastPlayed(tvId, season, episode) {
        localStorage.setItem(`lastPlayedSeason_${tvId}`, season);
        localStorage.setItem(`lastPlayedEpisode_${tvId}`, episode);
      }

      // Function to retrieve last played episode and season from localStorage
      function getLastPlayed(tvId) {
        const lastPlayedSeason = localStorage.getItem(`lastPlayedSeason_${tvId}`);
        const lastPlayedEpisode = localStorage.getItem(`lastPlayedEpisode_${tvId}`);
        return {
          season: lastPlayedSeason ? parseInt(lastPlayedSeason) : 1,
          episode: lastPlayedEpisode ? parseInt(lastPlayedEpisode) : 1
        };
      }

      // Update source button display
      function updateSourceButton(source) {
        const sourceText = selectedSource.querySelector('span');
        sourceText.textContent = source;
      }

      // Source dropdown toggle
      selectedSource.addEventListener('click', (e) => {
        e.stopPropagation();
        sourceDropdown.classList.toggle('active');
      });

      // Source selection
      document.querySelectorAll('.source-option').forEach(option => {
        option.addEventListener('click', (e) => {
          e.stopPropagation();
          currentSource = option.dataset.source;
          updateSourceButton(currentSource);

          // Update active state
          document.querySelectorAll('.source-option').forEach(opt => opt.classList.remove('active'));
          option.classList.add('active');

          sourceDropdown.classList.remove('active');
          console.log("Selected Source:", currentSource);
          updatePlayerFrame(tmdbId, currentSeason, currentEpisode);
        });
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', () => {
        sourceDropdown.classList.remove('active');
      });

      // Initialize
      fetchMovieDetails(imdbId);
    </script>
  </body>
</html>
